<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin - Ninja Hub</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="navbar">
        <button class="nav-btn active" onclick="ver('ninjas', event)">NINJAS</button>
        <button class="nav-btn" onclick="ver('eventos', event)">EVENTOS</button>
        <button class="nav-btn" onclick="ver('ganadores', event)">PREMIOS</button>
    </div>

    <div class="container">
        <div id="ninjas" class="tab-content" style="display:block">
            <h2>Gestión de Ninjas</h2>
            <input type="text" id="n-nom" placeholder="Nombre">
            <input type="number" id="n-pts" value="0">
            <button onclick="addNinja()">Añadir Ninja</button>
            <table border="1" style="margin-top:10px">
                <tbody id="list-n"></tbody>
            </table>
        </div>

        <div id="eventos" class="tab-content" style="display:none">
            <h2>Torneos</h2>
            <input type="text" id="e-nom" placeholder="Evento">
            <input type="date" id="e-fec">
            <button onclick="addEvento()">Crear Evento</button>
            <table border="1" style="margin-top:10px">
                <tbody id="list-e"></tbody>
            </table>
        </div>

        <div id="ganadores" class="tab-content" style="display:none">
            <h2>Suma de Puntos y Ganadores</h2>
            <select id="sel-e"></select>
            <select id="sel-n"></select>
            <input type="number" id="pts-plus" placeholder="Puntos a sumar" value="0">
            <input type="text" id="premio" placeholder="Premio">
            <button onclick="saveWinner()">GUARDAR Y SUMAR</button>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('https://ekaiwrnvbpwaaoenwnnp.supabase.co', 'sb_publishable_YvgUfE8sAXfAUGvXMcNB4Q_aGC2GUMP');

        function ver(id, e) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            e.currentTarget.classList.add('active');
        }

        async function refresh() {
            const { data: n } = await _supabase.from('ranking').select('*').order('puntos', { ascending: false });
            document.getElementById('list-n').innerHTML = n.map(u => `<tr><td>${u.nombre}</td><td>${u.puntos}</td><td><button onclick="editP(${u.id},${u.puntos})">EDITAR</button></td></tr>`).join('');
            document.getElementById('sel-n').innerHTML = n.map(u => `<option value="${u.nombre}">${u.nombre}</option>`).join('');

            const { data: e } = await _supabase.from('eventos').select('*').order('fecha', { ascending: false });
            document.getElementById('list-e').innerHTML = e.map(ev => `<tr><td>${ev.fecha}</td><td>${ev.nombre}</td><td><button onclick="delE(${ev.id})">X</button></td></tr>`).join('');
            document.getElementById('sel-e').innerHTML = e.map(ev => `<option value="${ev.id}">${ev.nombre}</option>`).join('');
        }

        async function saveWinner() {
            const eid = document.getElementById('sel-e').value;
            const nom = document.getElementById('sel-n').value;
            const pts = parseInt(document.getElementById('pts-plus').value);
            const pre = document.getElementById('premio').value;

            await _supabase.from('ganadores').insert([{ evento_id: eid, nombre_jugador: nom, premio: pre }]);
            const { data: u } = await _supabase.from('ranking').select('puntos').eq('nombre', nom).single();
            await _supabase.from('ranking').update({ puntos: u.puntos + pts }).eq('nombre', nom);
            alert("Puntos sumados!"); refresh();
        }

        async function addNinja() { await _supabase.from('ranking').insert([{ nombre: document.getElementById('n-nom').value, puntos: document.getElementById('n-pts').value }]); refresh(); }
        async function addEvento() { await _supabase.from('eventos').insert([{ nombre: document.getElementById('e-nom').value, fecha: document.getElementById('e-fec').value }]); refresh(); }
        async function delE(id) { await _supabase.from('eventos').delete().eq('id', id); refresh(); }
        async function editP(id, p) { const v = prompt("Pts", p); if(v) { await _supabase.from('ranking').update({ puntos: v }).eq('id', id); refresh(); } }

        window.onload = refresh;
    </script>
</body>
</html>

