<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Ninja Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #1a1a1a; color: white; margin: 0; padding: 0; }
        .navbar { background-color: #000; padding: 15px; display: flex; gap: 10px; border-bottom: 2px solid #00f2ff; }
        .nav-btn { background: none; border: 1px solid #444; color: #888; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .nav-btn.active { background-color: #00f2ff; color: black; border-color: #00f2ff; }
        .container { padding: 20px; max-width: 800px; margin: auto; }
        .tab-content { background-color: #2a2a2a; padding: 25px; border-radius: 15px; border: 1px solid #444; margin-top: 20px; }
        h2 { color: #00f2ff; margin-top: 0; }
        input, select { padding: 12px; background: #111; color: white; border: 1px solid #444; border-radius: 8px; width: 100%; margin-bottom: 15px; box-sizing: border-box; display: block; }
        button.primary { background-color: #00f2ff; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        td { padding: 10px; border-bottom: 1px solid #444; }
        .btn-del { background: #ff4444; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="navbar">
        <button class="nav-btn active" onclick="tab('n', event)">USUARIOS</button>
        <button class="nav-btn" onclick="tab('e', event)">TORNEOS</button>
        <button class="nav-btn" onclick="tab('g', event)">ASIGNAR PUNTOS</button>
    </div>

    <div class="container">
        <div id="n" class="tab-content">
            <h2>Gestión de Usuarios</h2>
            <input type="text" id="nn" placeholder="Nombre Ninja">
            <input type="number" id="np" placeholder="Puntos Iniciales" value="0">
            <input type="text" id="na" placeholder="Link Foto Discord (Opcional)">
            <button class="primary" onclick="addN()">REGISTRAR NINJA</button>
            <table id="table-n"></table>
        </div>

        <div id="e" class="tab-content" style="display:none">
            <h2>Gestión de Torneos</h2>
            <input type="text" id="en" placeholder="Nombre Evento">
            <input type="date" id="ef">
            <button class="primary" onclick="addE()">CREAR EVENTO</button>
            <table id="table-e"></table>
        </div>

        <div id="g" class="tab-content" style="display:none">
            <h2>Resultados y Suma Automática</h2>
            <label>1. Selecciona Torneo:</label><select id="se"></select>
            <label>2. Selecciona Ganador:</label><select id="sn"></select>
            <label>3. Puntos a SUMAR:</label><input type="number" id="pg" value="0">
            <label>4. Premio:</label><input type="text" id="pr" placeholder="Ej: 50 USDT">
            <button class="primary" onclick="save()">GUARDAR Y SUMAR PUNTOS</button>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('https://ekaiwrnvbpwaaoenwnnp.supabase.co', 'sb_publishable_YvgUfE8sAXfAUGvXMcNB4Q_aGC2GUMP');

        function tab(id, ev) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            ev.currentTarget.classList.add('active');
        }

        async function refresh() {
            const { data: n } = await _supabase.from('ranking').select('*').order('puntos', { ascending: false });
            const { data: e } = await _supabase.from('eventos').select('*').order('fecha', { ascending: false });

            document.getElementById('table-n').innerHTML = n.map(u => `
                <tr>
                    <td><strong>${u.nombre}</strong></td>
                    <td style="color:#00f2ff; font-weight:bold;">${u.puntos}</td>
                    <td>
                        <button onclick="editPuntos(${u.id}, '${u.nombre}', ${u.puntos})" style="background:#ffcc00; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:10px;">EDITAR</button>
                        <button class="btn-del" onclick="delN(${u.id})">ELIMINAR</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('sn').innerHTML = n.map(u => `<option value="${u.nombre}">${u.nombre}</option>`).join('');
            document.getElementById('table-e').innerHTML = e.map(ev => `
                <tr><td>${ev.fecha}</td><td>${ev.nombre}</td><td><button class="btn-del" onclick="delE(${ev.id})">X</button></td></tr>
            `).join('');
            document.getElementById('se').innerHTML = e.map(ev => `<option value="${ev.id}">${ev.nombre} (${ev.fecha})</option>`).join('');
        }

        async function save() {
            const eid = document.getElementById('se').value;
            const nom = document.getElementById('sn').value;
            const pts = parseInt(document.getElementById('pg').value);
            await _supabase.from('ganadores').insert([{ evento_id: eid, nombre_jugador: nom, premio: pts }]);
            const { data: u } = await _supabase.from('ranking').select('puntos').eq('nombre', nom).single();
            const totalNuevo = (u ? u.puntos : 0) + pts;
            await _supabase.from('ranking').update({ puntos: totalNuevo }).eq('nombre', nom);
            await _supabase.from('logs').insert([{ ninja_nombre: nom, puntos_cambiados: pts, tipo_accion: "Torneo", detalle: "Torneo ID: " + eid }]);
            alert("¡Puntos registrados!"); 
            refresh();
        }

        async function editPuntos(id, nombre, puntosActuales) {
            const valor = prompt("Puntos actuales de " + nombre + ": " + puntosActuales + "\n¿Cuál es el NUEVO TOTAL?");
            if (valor !== null && valor !== "") {
                const nuevosPuntos = parseInt(valor);
                if (!isNaN(nuevosPuntos)) {
                    await _supabase.from('ranking').update({ puntos: nuevosPuntos }).eq('id', id);
                    await _supabase.from('logs').insert([{ ninja_nombre: nombre, puntos_cambiados: nuevosPuntos - puntosActuales, tipo_accion: "Modificación", detalle: "Ajuste manual." }]);
                    refresh(); 
                }
            }
        }

        async function addN() { 
            const n = document.getElementById('nn').value;
            const p = document.getElementById('np').value;
            const a = document.getElementById('na').value; // El link de la foto
            if(n) {
                await _supabase.from('ranking').insert([{ nombre: n, puntos: p, avatar_url: a }]); 
                document.getElementById('nn').value = "";
                document.getElementById('na').value = "";
                refresh();
            }
        }

        async function addE() { await _supabase.from('eventos').insert([{ nombre: document.getElementById('en').value, fecha: document.getElementById('ef').value }]); refresh(); }
        async function delN(id) { if(confirm('¿Borrar?')) { await _supabase.from('ranking').delete().eq('id', id); refresh(); } }
        async function delE(id) { if(confirm('¿Borrar?')) { await _supabase.from('eventos').delete().eq('id', id); refresh(); } }

        window.onload = refresh;
    </script>
</body>
</html>
