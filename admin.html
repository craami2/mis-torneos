<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel | Injective Ninja</title>
    <link rel="stylesheet" href="style.css"> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="navbar">
    <button class="nav-btn active" onclick="openTab(event, 'usuarios')">USUARIOS</button>
    <button class="nav-btn" onclick="openTab(event, 'eventos')">TORNEOS</button>
    <button class="nav-btn" onclick="openTab(event, 'ganadores')">RESULTADOS/PUNTOS</button>
</div>

<div class="container">
    <div id="usuarios" class="tab-content" style="display:block;">
        <h2>Gestión de Usuarios</h2>
        <input type="text" id="ninja-nombre" placeholder="Nombre del Ninja">
        <input type="number" id="ninja-puntos" placeholder="Puntos" value="0">
        <button onclick="crearNinja()">+ REGISTRAR</button>
        <table>
            <thead><tr><th>NINJA</th><th>PUNTOS</th><th>ACCIONES</th></tr></thead>
            <tbody id="lista-ninjas"></tbody>
        </table>
    </div>

    <div id="eventos" class="tab-content" style="display:none;">
        <h2>Gestión de Torneos</h2>
        <input type="text" id="ev-nombre" placeholder="Nombre del Torneo">
        <input type="date" id="ev-fecha">
        <button onclick="crearEvento()">+ CREAR EVENTO</button>
        <tbody id="lista-eventos-table"></tbody> </div>

    <div id="ganadores" class="tab-content" style="display:none;">
        <h2>Asignar Ganadores y Sumar Puntos</h2>
        <select id="select-evento"><option>Cargando eventos...</option></select>
        <select id="select-ninja-ganador"><option>Cargando ninjas...</option></select>
        <input type="number" id="ganador-puntos-sumar" placeholder="Puntos a sumar (ej: 50)" value="0">
        <input type="text" id="ganador-premio" placeholder="Premio (ej: 100 USDT)">
        <button onclick="asignarGanador()">GUARDAR Y SUMAR</button>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://ekaiwrnvbpwaaoenwnnp.supabase.co', 'sb_publishable_YvgUfE8sAXfAUGvXMcNB4Q_aGC2GUMP');

    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = "none");
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add('active');
    }

    async function cargarNinjas() {
        const { data } = await _supabase.from('ranking').select('*').order('puntos', { ascending: false });
        document.getElementById('lista-ninjas').innerHTML = data.map(n => `
            <tr><td>${n.nombre}</td><td style="color:cyan">${n.puntos}</td>
            <td><button onclick="editarPuntos(${n.id},'${n.nombre}',${n.puntos})">EDITAR</button>
            <button onclick="eliminarNinja(${n.id})" style="background:red">X</button></td></tr>
        `).join('');
        document.getElementById('select-ninja-ganador').innerHTML = data.map(n => `<option value="${n.nombre}">${n.nombre}</option>`).join('');
    }

    async function editarPuntos(id, nombre, actuales) {
        const nuevo = prompt("Puntos para " + nombre, actuales);
        if (nuevo) { 
            await _supabase.from('ranking').update({ puntos: parseInt(nuevo) }).eq('id', id);
            cargarNinjas();
        }
    }

    async function eliminarNinja(id) {
        if(confirm("¿Eliminar?")) { await _supabase.from('ranking').delete().eq('id', id); cargarNinjas(); }
    }

    async function asignarGanador() {
        const ev_id = document.getElementById('select-evento').value;
        const nombre = document.getElementById('select-ninja-ganador').value;
        const puntos = parseInt(document.getElementById('ganador-puntos-sumar').value) || 0;
        const premio = document.getElementById('ganador-premio').value;

        await _supabase.from('ganadores').insert([{ evento_id: ev_id, nombre_jugador: nombre, premio }]);
        
        const { data: user } = await _supabase.from('ranking').select('puntos').eq('nombre', nombre).single();
        if(user) {
            await _supabase.from('ranking').update({ puntos: user.puntos + puntos }).eq('nombre', nombre);
            alert("Puntos sumados correctamente");
            cargarNinjas();
        }
    }

    async function cargarEventosAdmin() {
        const { data } = await _supabase.from('eventos').select('*').order('fecha', { ascending: false });
        document.getElementById('select-evento').innerHTML = data.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
    }

    window.onload = () => { cargarNinjas(); cargarEventosAdmin(); };
</script>
</body>
</html>
